# Testing

```bash
$ npm run bundle
```

Rollup will generate
- IIFE module: `dist_/text2chart.min.js`
- mjs module: `dist_/index.mjs`
- cjs module: `dist_/index.cjs`

*Though cjs file can have extension as `js`, but since hosting package type is "module", consumer application can't use `require` to import a package from "module" type package until the extension is `cjs`.


## Browser testing

### IIFE

IIFE module can be included in browser directly as follow.

```
<script src="/text2chart.min.js"></script>

  <script>
    const text = `
      FLOW: testing cjs
      step 1
      and last
    `;

    new Text2Chart.FlowChart({
      target: document.getElementById('app'),
      props: {
        text: text
        // any props you want to pass to the FlowChart component
      }
    });
  </script>
```

Open `_dist\index.html` in browser to test IIFE module.

### MJS

MJS module can also be imported in browser directly as follow.

```
<script type="module">
  import { FlowChart } from '/index.mjs'; // Adjust path as needed

  const text = `
    FLOW: testing cjs
    step 1
    and last
  `;
  // Optionally, you can render it to the page
  new FlowChart({
    target: document.getElementById('app'),
    props: {
      text: text
      // any props you want to pass to the FlowChart component
    }
  });
</script>
```

Open `_dist\mjs.html` in browser to test IIFE module.

## Nodejs testing

Rollup generated files need to be specified in package.json so that any other  package can import them,

package.json of publishing library
```json
"types": "./dist/index.d.ts",
"svelte": "./dist/index.js",
"exports": {
  ".": {
    "types": "./dist/index.d.ts",
    "svelte": "./dist/index.js",
    "import": "./dist_/index.mjs",
    "require": "./dist_/index.cjs"
  },
  "./Flow.svelte": {
    "types": "./dist/flow/FlowChart.svelte.d.ts",
    "svelte": "./dist/flow/FlowChart.svelte"
  },
  "./flow": {
    "types": "./dist/flow/index.d.ts",
    "svelte": "./dist/flow/index.js"
  },
  "./style.css": "./dist_/bundle.css"
},
"files": [
  "dist",
  "dist_",
  "!dist/**/*.test.*",
  "!dist/**/*.spec.*",
  "README.md",
  "LICENSE"
],
```

Note
- We have generated `dist_/*` by rollup. All files in `dist/*` are generated by `svelte-package`.
- "types" property must be first property for an entry point as referred by typescript compile at the time of svelte packaging.
- For above configuration in `package.json`, a consumer application can import a package as `const {FlowChart} = require('@solothought/text2chart');` but not as `const FlowChart = require('@solothought/text2chart/flow');`. However, if we add `require` or `import` to `./flow` entry point then, both type of imports will work;
```
"exports": {
  ".": {
    //..
    "require": "./dist_/index.cjs"
  },
  "./flow": {
    "types": "./dist/flow/index.d.ts",
    "svelte": "./dist/flow/index.js"
    "require": "./dist_/index.cjs"
  }
},
```
- files mentioned in `exports` property must present in `files` property

### Common JS (CJS)

Create node js project with common js module
```bash
$ npm init -y
```
main.js
```
const {FlowChart} = require('@solothought/text2chart');
require('@solothought/text2chart/style.css');

new FlowChart({
  target: document.getElementById('app'),
  props: {
    text: `
    FLOW: cjs
    step1
    step end`
  }
});
```

Since the browser can't understand commonjs module, we'll have to use rollup(vite ot other) to transform it in IIFE module. And import transformed js in HTML page.

To setup rolloup for this basic project, following dependencies are sufficient
- `@rollup/plugin-commonjs`
- `@rollup/plugin-node-resolve`
- `@rollup/plugin-replace`
- `rollup`
- `rollup-plugin-css-only`

```js
// rollup.config.js
const css = require('rollup-plugin-css-only');
const resolve = require('@rollup/plugin-node-resolve');
const commonjs = require('@rollup/plugin-commonjs');
const replace = require('@rollup/plugin-replace');

module.exports = [
  {
    input: 'main.js',
    output: [
      { file: 'dist/main.min.js', format: 'iife', sourcemap: true }
    ],
    plugins: [
      replace({
        'process.env.NODE_ENV': JSON.stringify('production'), // Replace with production environment
        preventAssignment: true // Required to avoid certain warnings
      }),
      css({ output: 'bundle.css' }), // Output collected CSS into a single file
      resolve({
        browser: true, // Ensure that dependencies can be resolved for the browser
      }),
      commonjs(),
    ]
  }
];
```
Now you import generated CSS and js file in webpage
```
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Text2Chart Test</title>
  <link rel="stylesheet" href="./dist/bundle.css" />
</head>
<body>
  <div id="app"></div>
  <script type="module" src="/dist/main.min.js"></script>
</body>
</html>
```

You'll find the setup in `tests\cjs`.

### MJS
You can import mjs module in browser(webpage) directly without rollup or any other transformation only if it doesn't import no extra library. Any library used by a module is referred from `node_module` that browser doesn't understand. Hence, we need bundling.

#### Rollup
Bundle Dependencies with Rollup for Browser Compatibility

```
// rollup.config.js
const css = require('rollup-plugin-css-only');
const resolve = require('@rollup/plugin-node-resolve');
const replace = require('@rollup/plugin-replace');

module.exports = [
  {
    input: 'main.js',
    output: [ { file: 'dist/bundle.mjs', format: 'es', sourcemap: true  } ],
    plugins: [
      replace({
        'process.env.NODE_ENV': JSON.stringify('production'), // Replace with production environment
        preventAssignment: true // Required to avoid certain warnings
      }),
      css({ output: 'bundle.css' }), // Output collected CSS into a single file
      resolve(),
    ]
  }
];
```
main.js
```
import {FlowChart} from '@solothought/text2chart';
import '@solothought/text2chart/style.css';

new FlowChart({
  target: document.getElementById('app'),
  props: {
    text: `
    FLOW: cjs
    step1
    step end`
  }
});
```
index.html
```
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Text2Chart Test</title>
  <link rel="stylesheet" href="./dist/bundle.css" />
</head>
<body>
  <div id="app"></div>
  <script type="module" src="/dist/main.min.js"></script>
</body>
</html>
```

#### Skypack or JSPM CDN
CDNs like Skypack and JSPM offer on-demand bundling, which resolves Node.js packages to browser-compatible URLs. You can load your package this way:

main.js
```
import { FlowChart } from 'https://cdn.skypack.dev/@solothought/text2chart';
import 'https://cdn.skypack.dev/@solothought/text2chart/dist_/style.css';

new FlowChart({
  target: document.getElementById('app'),
  props: {
    text: `
    FLOW: mjs
    step1
    step end`
  }
});
```
Now you need to bundle them and can import directly in webpage
```
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Text2Chart Test</title>
</head>
<body>
  <div id="app"></div>
  <script type="module" src="./main.js"></script>
</body>
</html>
```

This solution will not work if there is any local dependency installed.

#### Vite
Use a Development Server with Module Resolution Support. Using a tool like Vite or Snowpack are development servers support bare module specifiers and automatically resolve them to files in `node_modules`. 

```bash
$ npm install vite --save-dev
```
define a script in package.json
```json
"scripts": {
  "dev": "vite"
}
```
Start the Development Server:
```bash
$ npm run dev
```

This works same as rollup on the fly.

### Svelte
Now we'll setup a complete svelte project and use our library as svelte component.

- [Create a svelte project](./SvelteProject.md)
- Install the library
```bash 
$ npm install ../..
#$ npm install @solothought/text2chart
```

Import the library in `lib/my-component.svelte`
```html
<script>
  import FlowChart from "@solothought/text2chart/Flow.svelte";
  import "@solothought/text2chart/style.css"

  const text = `
    FLOW: Text2Chart Flow
    use as svelte component
    üôèüèº
  `;
</script>

<FlowChart style="width:100vw; height:100vh" {text} />
```

Import this component in `routes/+page.svelte`
```
<script>
  import MyComponent from "$lib/my-component.svelte";
</script>
<MyComponent />
```

Test it in browser
```bash
$ npm dev run
```